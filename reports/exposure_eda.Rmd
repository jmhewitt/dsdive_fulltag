---
title: "EDA for exposure effects"
author: Josh
date: 16 September 2020
output:
  html_document:
    toc: false
    toc_float:
      collapsed: false
      smooth_scroll: true
      number_sections: true
params:
  dive_labels: dive_labels
  template_bins: template_bins
  depth_files: depth_files
  cee_starts: cee_starts
  window_length: 12
  response_lag: 12
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = FALSE, message = FALSE, 
                      warning = FALSE)
```

```{r load, cache = FALSE}
loadd(params$dive_labels)
loadd(params$template_bins)
loadd(params$depth_files)
loadd(params$cee_starts)
```

```{r pre_process_tags, include = FALSE}
eda_data = lapply(1:length(dive_labels), function(tagId) {
  
  # copy labels and tag name
  res = dive_labels[[tagId]]
  
  # load data
  d = read.csv(file.path('..', depth_files[[tagId]]))
  d$Date = anytime(paste(d$Day, d$Time))
  
  # map all depths to standardized bins
  d$depth.bin = sapply(d$Depth, function(depth) {
    which.min(abs(depth - template_bins$center))
  })
  d$depth.standardized = template_bins$center[d$depth.bin]
  
  # export standardized depths and times
  res$depth.bin = d$depth.bin
  res$depths = d$depth.standardized
  res$times = d$Date
  
  # determine tag's temporal support
  tag_start = d$Date[1]
  tag_end = d$Date[length(d$Date)]
  
  # determine which CEE's overlap with tag record
  cees_experienced = which((tag_start <= cee_starts) & (cee_starts <= tag_end))

  # pre/post exposure labels
  if(length(cees_experienced) == 0) {
    res$exposure_time = Inf
    res$exposed = numeric(length(res$depths))
  } else {
    res$exposure_time = cee_starts[min(cees_experienced)]
    res$exposed = as.numeric(d$Date >= res$exposure_time)
  }
  
  res
})
```

```{r eda_stats, include = FALSE} 
eda_stats = lapply(eda_data, function(tag_record) {
  res = bootstrap_exposure(
    depths = tag_record$depths, times = tag_record$times, 
    response_lag = params$response_lag,
    window_length = params$window_length, 
    dive_labels = tag_record$labels, nsamples = 1e2, 
    exposure_time = tag_record$exposure_time, deep_depth = 800, 
    statistic = function(x, y, x_labels = NULL, y_labels = NULL) {
      
      # put depths into tidy format, to facilitate marginal distributions
      df = data.frame(depth = c(x, y), 
                      type = c(rep('pre', length(x)),
                               rep('post', length(y))),
                      label = c(x_labels, y_labels)
                      )
      
      # identify deep dives by label 
      #   (assumes x_labels and y_labels are from same tag)
      deep_labels = df %>% 
        dplyr::group_by(label) %>% 
        dplyr::summarize(deep = max(depth) > 800) %>% 
        dplyr::filter(deep == TRUE) %>% 
        dplyr::select(label) %>% 
        unlist()
      
      # summarize characteristics of pre/post shallow dives
      shallow_summary = df %>% 
        dplyr::filter(!(label %in% deep_labels)) %>% 
        dplyr::group_by(type) %>% 
        dplyr::summarise(
          prop_surface = mean(depth == template_bins$center[1]),
          total_distance = sum(abs(diff(depth)))
        )
      
      # sequence of midpoint differences
      dx = diff(x)
      dy = diff(y)
      
      # sequence of ups/downs/no-changes
      dx.sign = sign(dx)
      dy.sign = sign(dy)

      # compute sample statistics
      stats = c(
        # SSE between marginal depth bin distributions
        marginal_bins = sum(apply(table(df), 1, diff)^2),
        # SSE between proportion of downward movements
        prop_downward = (mean(dx.sign == 1) - mean(dy.sign == 1))^2,
        # SSE between proportion of upward movements
        prop_upward = (mean(dx.sign == -1) - mean(dy.sign == -1))^2,
        # SSE between proportion of no-change "movements"
        prop_upward = (mean(dx.sign == 0) - mean(dy.sign == 0))^2,
        # SSE between total up distance
        total_upward = (sum(dx[dx>0]) - sum(dy[dy>0]))^2,
        # SSE between total down distance
        total_downward = (sum(dx[dx<0]) - sum(dy[dy<0]))^2,
        # SSE between total absolute distance
        total_movement = (sum(abs(dx)) - sum(abs(dy)))^2,
        # SSE between proportion of surface observations in shallow periods
        prop_shallow_surface = diff(shallow_summary$prop_surface)^2,
        # SSE between total absolute distance in shallow periods
        total_shallow_movement = diff(shallow_summary$total_distance)^2
      )
      
      stats
    }
  )
  
  if(is.null(res)) {
    res = list()
  }
  
  res$tag = tag_record$tag
  res
  
})
```

Window length: <span style="color:blue">`r params$window_length`</span> hours
<br />
Window lag: <span style="color:blue">`r params$response_lag`</span> hours



# {.tabset}

## Overview

### Introduction

This exploratory analysis studies the impact of exposure on diving behavior in a 
non-parametric, empirical framework.  Exposure is studied through distances
between two sequences of depth bin observations: depth bins observed in the last
<span style="color:blue">`r params$window_length`</span> hours before an 
exposure, then <span style="color:blue">`r params$window_length`</span> hours of 
depth bin observations starting 
<span style="color:blue">`r params$response_lag`</span> hours after exposure.

The observed distance's significance is quantified via a Monte Carlo---or 
bootstrap---p-value.  The null (or sampling) distribution associated with the 
p-value is the distribution of the distance function when it is applied to two 
<span style="color:blue">`r params$window_length`</span>-hour sequences 
of unexposed depth bin observations, separated by 
<span style="color:blue">`r params$response_lag`</span> hours.  The 
null distribution is approximated via sampling.

### Sampling units

Studying <span style="color:blue">`r params$window_length`</span>-hour 
windows is slightly different from both my initial 
analysis and Alan's proposal.  My initial analysis used pre-exposure shallow 
dives as the sampling unit, and I sampled the same number of pre-exposure 
shallow dives as were observed after the actual exposure.  Alan suggests using 
<span style="color:blue">`r params$window_length`</span>-hour time windows as the 
sampling unit, which is like a "time series" version 
of my sampling units.  The time series approach captures both deep and shallow 
dives, as well as some of the sequential nature of diving behavior.

When considering a time series approach, I chose to work with 
<span style="color:blue">`r params$window_length`</span>-hour windows separated 
by <span style="color:blue">`r params$response_lag`</span> hours in order to 
highlight changes in short-term behavior, while 
using the Monte Carlo sampling to empirically average over different patterns of 
short-term behavior.  As Nic often mentions, short-term behavior may vary 
according to longer-term behavior, which may be difficult to describe.


### Distances, briefly explained

Each distance function $\text{d}(pre,post)$ operates on a sequence of 
"pre-exposure" and "post-exposure" depth bin observations.  Of course, to 
compute the null/sampling distribution, both sequences $pre$ and $post$ are 
sampled before the exposure occurred.  It would be more precise to 
define the distance $\text{d}(pre,post)$ as the function $\text{d}(x,y)$ with 
respect to sequences of depth bin observations $x$ and $y$.  I will adopt this 
notation below.

#### SSE between depth bin counts

Compare the marginal distribution of depth bins via

$\text{d}(x,y) = \sum_i (N_x(i) - N_y(i))^2$,

where $N_x(i)$ is the number of times depth bin $i$ was observed in the 
sequence $x$, and $N_y(i)$ is defined similarly for $y$.

#### SSE between proportion of downward movements

Compare the proportion of downward movements via 

$\text{d}(x,y) = \left(\frac{N_{x,down}}{N_x} - \frac{N_{y,down}}{N_y}\right)^2$,

where $N_{x,down}$ is the number of downward transitions observed in $x$, 
$N_x$ is the length of the sequence $x$, and $N_{y,down}$ and $N_y$ are defined 
similarly for $y$.

#### SSE between proportion of upward movements

Compare the proportion of upward movements via 

$\text{d}(x,y) = \left(\frac{N_{x,up}}{N_x} - \frac{N_{y,up}}{N_y}\right)^2$,

where $N_{up}$ is the number of upward transitions observed in $x$, 
$N_x$ is the length of the sequence $x$, and $N_{y,up}$ and $N_y$ are defined 
similarly for $y$.

#### SSE between proportion of no-change "movements"

Compare the proportion of times no movement was observed via 

$\text{d}(x,y) = \left(\frac{N_{x,equal}}{N_x} - \frac{N_{y,equal}}{N_y}\right)^2$,

where $N_{x,equal}$ is the number of times no movement was observed in $x$, 
$N_x$ is the length of the sequence $x$, and $N_{y,equal}$ and $N_y$ are defined 
similarly for $y$.

#### SSE between total up distance

Compare the total upward distance traveled via 

$\text{d}(x,y) = \left(
    \sum_{i=2}^{N_x} (x_i - x_{i-1})\text{I}\{x_i > x_{i-1}\} - 
    \sum_{i=2}^{N_y} (y_i - y_{i-1})\text{I}\{y_i > y_{i-1}\}
  \right)^2$,

where $N_x$ is the number of observations in $x$, $x_i$ is the midpoint depth 
of the $i$th depth bin observation in $x$, and $\text{I}\{\cdot\}$ is the 
indicator function.  Here the indicator 
function is used to restrict the summation to transitions from deeper 
observations to shallower observations.  All notation is similarly defined for 
$y$.

#### SSE between total down distance

Compare the total downward distance traveled via 

$\text{d}(x,y) = \left(
    \sum_{i=2}^{N_x} (x_i - x_{i-1})\text{I}\{x_i < x_{i-1}\} - 
    \sum_{i=2}^{N_y} (y_i - y_{i-1})\text{I}\{y_i < y_{i-1}\}
  \right)^2$,

where $N_x$ is the number of observations in $x$, $x_i$ is the midpoint depth 
of the $i$th depth bin observation in $x$, and $\text{I}\{\cdot\}$ is the 
indicator function.  Here the indicator 
function is used to restrict the summation to transitions from shallower 
observations to deeper observations.  All notation is similarly defined for 
$y$.

#### SSE between total absolute distance

Compare the total distance traveled via 

$\text{d}(x,y) = \left(
    \sum_{i=2}^{N_x} \vert x_i - x_{i-1} \vert - 
    \sum_{i=2}^{N_y} \vert y_i - y_{i-1} \vert
  \right)^2$,

where $N_x$ is the number of observations in $x$, $x_i$ is the midpoint depth 
of the $i$th depth bin observation in $x$, and $\vert\cdot\vert$ is the 
absolute value function. All notation is similarly defined for 
$y$.

#### SSE between proportion of surface observations in shallow periods

Compare the proportion of surface bin observations during shallow periods via 

$\text{d}(x,y) = \left(
    \frac{N_{x,shallow}(1)}{N_{x,shallow}} - 
    \frac{N_{y,shallow}(1)}{N_{y,shallow}}
  \right)^2$,

where $N_{x,shallow}$ is the number of observations in $x$ that are not 
associated with a deep dive, and $N_{x,shallow}(1)$ is the number of times the 
shallowest depth bin (i.e., the surface bin) was observed among the observations 
that contribute to $N_{x,shallow}$. All notation is similarly defined for 
$y$.


#### SSE between total absolute distance in shallow periods

Compare the total distance traveled during shallow periods via 

$\text{d}(x,y) = \left(
    \sum_{i=2}^{N_x} \vert x_i - x_{i-1} \vert 
      \text{I}( \text{Class}(x_{i-1}) \in \{\text{Shallow dive}, \text{Surface}\}) - 
    \sum_{i=2}^{N_y} \vert y_i - y_{i-1} \vert
      \text{I}( \text{Class}(x_{i-1}) \in \{\text{Shallow dive}, \text{Surface}\})
  \right)^2$,

where $N_x$ is the number of observations in $x$, $x_i$ is the midpoint depth 
of the $i$th depth bin observation in $x$, $\vert\cdot\vert$ is the 
absolute value function, and $\text{I}(\cdot)$ is the indicator function.  Here, 
the indicator function restricts the sum to all transitions that started 
in a "non-deep" class, i.e., to transitions made during a shallow dive or from 
the surface (excluding transitions from the surface that began a deep dive).

## Results {.tabset}

As expected, there are some distances that suggest some response on some whales.
Nothing is consistent across whales.  It also appears that there are gaps in 
data collection for Zc 85 and 86, so I did not look closely at results for these 
whales.  The p-values are summarized in the table below, and p-values smaller 
than 0.1 are highlighted in orange, and p-values smaller than 0.05 are 
highlighted in green.  The additional tabs below present results for 
individual tags.

```{r stat_labels, include = FALSE}
stat_labels = c(
  'SSE between depth bin counts',
  'SSE between proportion of downward movements',
  'SSE between proportion of upward movements',
  'SSE between proportion of no-change "movements"',
  'SSE between total up distance',
  'SSE between total down distance',
  'SSE between total absolute distance',
  'SSE between proportion of surface observations in shallow periods',
  'SSE between total absolute distance in shallow periods'
)
```

```{r summary_table, echo = FALSE}

# put p-values into matrix format
pvals = data.frame(t(do.call(rbind, lapply(eda_stats, function(res) {
  if('p' %in% names(res)) {
    round(res$p, 2)
  } else {
    rep(NA, length(stat_labels))
  }
}))))

colnames(pvals) = sapply(eda_stats, function(res) res$tag)
rownames(pvals) = stat_labels

for(i in 1:ncol(pvals)) { 
  
  formatted_colors = sapply(pvals[, i], function(x) {
    color = 'white'
    if(is.finite(x)) {
      if(x < .1) { color = 'orange' }
      if(x < .05) { color = 'springgreen' }
    }
    color
  })
  
  pvals[, i] = cell_spec(x = pvals[, i], 
                         background = formatted_colors, 
                         bold = ifelse(formatted_colors == 'white', F, T))
  
}

kbl(pvals, escape = FALSE) %>% 
  kable_paper("hover", full_width = F)
```

<br/>
<br/>

```{r eda_densities, results = 'asis', echo = FALSE}

for(tagId in 1:length(eda_stats)) {
  
  res = eda_stats[[tagId]]
  
  # label tag with tagId
  cat('###', res$tag, ' \n\n')
  
  
  # plot tag around exposure
  dat = eda_data[[tagId]]
  if(is.finite(dat$exposure_time)) {
    date_range = dat$exposure_time + c(-1, 1) * hours(params$window_length)
    # base plot
    pl = tagplot(depths = data.frame(depth.standardized = dat$depths,
                                     Date = dat$times), 
                 depth.bins = template_bins, 
                 dives.labeled = dat$labels, 
                 date_range = date_range,
                 cee_starts = dat$exposure_time, depth_mark = 800)
    # highlight the pre/post window
    pl = pl + 
      geom_rect(data = data.frame(x = 0, y = 0),
                mapping = aes(xmin = date_range[1], xmax = date_range[2], 
                                 ymin = 0, ymax = Inf), inherit.aes = FALSE,
                   fill = NA, col = 'black', lwd = 2) + 
      ggtitle(label = 'Tag data with pre/post exposure window outlined (black)', 
              subtitle = '(Exposure occurred at dotted vertical line)')
    print(pl)
    cat(' \n\n')
  } else {
    cat ('Tag was unexposed. \n\n')
  }
  
  
  # sse
  if('p' %in% names(res)) {
    for(statInd in 1:length(res$p)) {
      
      # label plot with plot name
      cat('####', stat_labels[statInd], ' \n\n')
      
      pl = data.frame(x = res$null.samples[, statInd]) %>% 
        ggplot(aes(x = x)) + 
        stat_density(geom = 'line') +
        geom_vline(xintercept = res$test[statInd], lty = 3) + 
        ggtitle(
          label = 'Baseline density (black) with exposed value (dotted line)',
          subtitle = paste('p=', signif(res$p[statInd], 2), sep = '')) + 
        ylab('Density') + 
        xlab(expression(d(italic(pre), italic(post)))) + 
        theme_few() + 
        theme(panel.border = element_blank())
    
    print(pl)
    
    cat(' \n\n')
    
    }
    
  } else {
    cat('Tests were not able to run.')
  }
  
  cat(' \n\n')
}
```

## Brief discussion

- How many EDA measures and sampling schemes do we want to consider?
- How does the rest of the BRS community deal with inconsistent response 
  behaviors, and how does this inform our work?  For example, can we say that 
  our EDA detects a true response in Zc 93 and a true non-response in Zc 95? 
  If so, can we transition to formal modeling and simultaneously begin drafting 
  a manuscript describing how to use our methodology to detect responses in 
  individual animals?  
- It might be premature to try to tackle holistic, population-level 
  response models.  However, I think that formally a model for individual 
  responses should still be worthwhile on its own.
  
