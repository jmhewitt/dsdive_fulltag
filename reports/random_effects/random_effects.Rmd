---
title: "Posterior diagnostics for random effects"
date: 6 April 2021
output: 
  pdf_document: 
    toc: no
header-includes:
  - \usepackage{booktabs}
params:
    tgt_dir: nim_fit
---

# Overview

The final model I have worked with estimates random effects for both vertical speed and stage transition parameters.  The posterior distributions for the random effects are included in this document.  The posterior distributions for nearly all of the random effects do not significantly differ from 0, suggesting that the terms add little tangible value to the model.


# Model specification

Random effects for speed parameters are incorporated into the model via the following hierarchical structure, where $\beta_{ijk}$ is the coefficient that uses the $i$th covariate to influence the vertical speed for the $j$th stage type and $k$th subject:
\begin{align*}
  \beta_{ijk} &\thicksim \mathcal N(\mu_{ij}, \sigma^2_{ij}), \\
  \mu_{ij} &\thicksim \mathcal N(0, 10^4), \\
  \sigma^2_{ij} &\thicksim \Gamma^{-1}(2, 1),
\end{align*}
where $\Gamma^{-1}(2, 1)$ is the inverse-gamma distribution with shape=2 and rate=1, so that the prior distribution has infinite variance and a mean of 1.

Random effects for stage transition parameters are modeled using the same structure and prior distributions as for $\beta_{ijk}$.

# Results

The figures below show posterior distributions for $\beta_{ijk} - \mu_{ij}$, to draw inference on individual deviation from population-level means.  The posterior distributions for virtually all of the random effects provide little evidence for significant individual deviation from the population-level means (Figures \ref{fig:beta_raneffs} and \ref{fig:betas_tx_raneffs}).  The effective sample sizes for all of the posteriors are fairly large, which suggests the model is likely mixing well over the random effects portion of the distribution (Figures \ref{fig:betas_tx_ess} and \ref{fig:beta_ess}).

The posterior distributions for the variance terms $\sigma^2_{ij}$ show evidence for learning relative to the prior distributions by seeing the posterior means generally decrease from the prior mean of 1.  The posteriors are easier to view on a log scale, so departures from 0 are the key thing to observe (Figures \ref{fig:betas_tx_var} and \ref{fig:beta_var}).


# Discussion

There may be some concern that the $\Gamma^{-1}(2, 1)$ prior distribution is too informative, but we addressed similar informativeness concerns in the original JABES paper and found little improvement by using less informative priors.  I am not sure there is too much to gain by re-running the model using alternate priors.



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, cache = TRUE, 
                      dev = 'png', dpi = 300, fig.width = 8, fig.height = 11)
```

```{r paths}
paths = list(
  # location of mcmc output files
  path_out = file.path('output', 'mcmc', params$tgt_dir),
  # identifying characteristics of key output files
  active_samplers = '*active_samplers.rds',
  param_sample_pattern = '*parameter_samples_[0-9]+',
  param_sample_column_labels = '*parameter_samples_column_labels.rds'
)
```

```{r mcmc_input}
nim_pkg = readRDS(dir(path = paths$path_out, pattern = 'pkg', 
                      full.names = TRUE))
```

```{r parameter_groups}
# load targets of active samplers
active_samplers = unlist(readRDS(
  dir(path = paths$path_out, pattern = paths$active_samplers, full.names = TRUE)
))

# identify common parameter names, excluding stages
parameter_families = setdiff(
  unique(gsub(pattern = '\\[.*\\]', replacement = '', x = active_samplers)),
  'stages'
)

# associate actively sampled targets with the common parameter names
sampler_groups = lapply(parameter_families, function(pfam) {
  grep(pattern = paste(pfam, '\\[', sep = ''), 
       x = active_samplers, value = TRUE)
})
names(sampler_groups) = parameter_families
sampler_groups = sampler_groups[order(names(sampler_groups))]

rm(active_samplers, parameter_families)
```

```{r output_files}
param_sample_files = dir(path = paths$path_out, 
                         pattern = paths$param_sample_pattern,
                         full.names = TRUE)

param_samples = do.call(rbind, lapply(param_sample_files, function(f) {
  readRDS(f)
}))

colnames(param_samples) = readRDS(
  dir(path = paths$path_out, pattern = paths$param_sample_column_labels, 
      full.names = TRUE)
)

rm(param_sample_files)
```

```{r set_burn}
burn = 1:1e3
```

# Animals analyzed 

```{r animmal_ids}
print(nim_pkg$consts$subject_id_labels)
```

# Random effects

```{r speed_raneffs, fig.cap='\\label{fig:beta_raneffs}Posterior means and HPDs for speed parameter random effects.'}
library(coda)
library(ggplot2)
library(ggthemes)

beta_grid = expand.grid(
  covariate = 1:nim_pkg$consts$n_covariates,
  stage = 1:nim_pkg$consts$n_stages,
  subject = 1:nim_pkg$consts$n_subjects
)

beta_results = do.call(rbind, apply(beta_grid, 1, function(r) { 
  
  tgt = paste('beta[', r['covariate'], ', ', r['stage'], ', ', r['subject'], 
              ']', sep = '')
  
  tgt_mu = paste('beta_mu[', r['covariate'], ', ', r['stage'], ']', sep = '')
  
  m = mcmc(param_samples[-burn, tgt] - param_samples[-burn, tgt_mu])
  if(var(m) == 0) {
    NULL 
  } else {
    hpds = HPDinterval(m)
    data.frame(t(r), mean = mean(m), hpds, ess = effectiveSize(m),
               Significant = ifelse(hpds[1, 'lower'] > 0 | hpds[1, 'upper'] < 0, 
                               TRUE, FALSE))
  }
}))

beta_results$stage = factor(
  x = beta_results$stage, 
  levels = 1:nim_pkg$consts$n_stages,
  labels = names(nim_pkg$consts$movement_types)
)

beta_results$covariate = factor(
  x = beta_results$covariate, 
  levels = 1:nim_pkg$consts$n_covariates,
  labels = rownames(nim_pkg$data$covariates)
)

ggplot(beta_results, aes(x = factor(subject), y = mean, ymin = lower, 
                         ymax = upper, col = Significant)) + 
  geom_hline(yintercept = 0, lty = 3) + 
  geom_pointrange() + 
  ylab(expression('Random effect for speed'~(beta))) +  
  scale_color_manual(values = c('FALSE' = 'black', 'TRUE' = '#e34a33')) + 
  xlab('Subject id') + 
  facet_grid(stage~covariate, scales = 'free') + 
  theme_few() + 
  ggtitle('Posterior means and HPD intervals for random effects')
```

```{r beta_ess, fig.cap='\\label{fig:beta_ess}Effective sample sizes for speed parameter random effects.'}
ggplot(beta_results, aes(x = factor(subject), y = ess)) + 
  geom_point() + 
  ylab('Effective sample size') +  
  xlab('Subject id') + 
  facet_grid(stage~covariate, scales = 'free') + 
  theme_few() + 
  ggtitle('Effective sample sizes for speed parameter random effects')
```

```{r transition_raneffs, fig.cap='\\label{fig:betas_tx_raneffs}Posterior means and HPDs for stage transition parameter random effects.'}
library(coda)
library(ggplot2)
library(ggthemes)

param_grid = expand.grid(
  covariate = 1:nim_pkg$consts$n_covariates,
  stage = 1:nim_pkg$consts$n_stage_txs,
  subject = 1:nim_pkg$consts$n_subjects
)

param_results = do.call(rbind, apply(param_grid, 1, function(r) { 
  
  tgt = paste('betas_tx[', r['covariate'], ', ', r['stage'], ', ', r['subject'], 
              ']', sep = '')
  
  tgt_mu = paste('betas_tx_mu[', r['covariate'], ', ', r['stage'], ']', sep = '')
  
  m = mcmc(param_samples[-burn, tgt] - param_samples[-burn, tgt_mu])
  
  if(var(m) == 0) {
    NULL 
  } else {
    hpds = HPDinterval(m)
    data.frame(t(r), mean = mean(m), hpds, ess = effectiveSize(m),
           Significant = ifelse(hpds[1, 'lower'] > 0 | hpds[1, 'upper'] < 0, 
                           TRUE, FALSE))
  }
}))

param_results$stage = factor(
  x = param_results$stage, 
  levels = 1:nim_pkg$consts$n_stage_txs,
  labels = colnames(nim_pkg$inits$betas_tx_mu)
)

param_results$covariate = factor(
  x = param_results$covariate, 
  levels = 1:nim_pkg$consts$n_covariates,
  labels = rownames(nim_pkg$data$covariates)
)

ggplot(param_results, aes(x = factor(subject), y = mean, ymin = lower, 
                         ymax = upper, col = Significant)) + 
  geom_hline(yintercept = 0, lty = 3) + 
  geom_pointrange() + 
  scale_color_manual(values = c('FALSE' = 'black', 'TRUE' = '#e34a33')) + 
  ylab(expression('Random effect for transition parameters'~(beta[tx]))) +  
  xlab('Subject id') + 
  facet_grid(stage~covariate, scales = 'free') + 
  theme_few() + 
  ggtitle('Posterior means and HPD intervals for random effects')
```

```{r ess_transitions, fig.cap='\\label{fig:betas_tx_ess}Effective sample sizes for stage transition parameter random effects.'}
ggplot(param_results, aes(x = factor(subject), y = ess)) + 
  geom_point() + 
  ylab('Effective sample size') +  
  xlab('Subject id') + 
  facet_grid(stage~covariate, scales = 'free') + 
  theme_few() + 
  ggtitle('Effective sample sizes for transition parameter random effects')
```

```{r transition_raneff_var, fig.cap='\\label{fig:betas_tx_var}Posterior means and HPDs for population-level variance of random effects for stage transition parameters.'}
library(coda)
library(ggplot2)
library(ggthemes)

param_grid = expand.grid(
  covariate = 1:nim_pkg$consts$n_covariates,
  stage = 1:nim_pkg$consts$n_stage_txs
)

param_results = do.call(rbind, apply(param_grid, 1, function(r) { 
  
  tgt_mu = paste('betas_tx_var[', r['covariate'], ', ', r['stage'], ']', 
                 sep = '')
  
  m = mcmc(log(param_samples[-burn, tgt_mu]))
  
  if(var(m) == 0) {
    NULL 
  } else {
    hpds = HPDinterval(m)
    data.frame(t(r), mean = mean(m), hpds, ess = effectiveSize(m),
           Significant = ifelse(hpds[1, 'lower'] > 0 | hpds[1, 'upper'] < 0, 
                           TRUE, FALSE))
  }
}))

param_results$stage = factor(
  x = param_results$stage, 
  levels = 1:nim_pkg$consts$n_stage_txs,
  labels = colnames(nim_pkg$inits$betas_tx_mu)
)

param_results$covariate = factor(
  x = param_results$covariate, 
  levels = 1:nim_pkg$consts$n_covariates,
  labels = rownames(nim_pkg$data$covariates)
)

ggplot(param_results, aes(x = stage, y = mean, ymin = lower, 
                         ymax = upper, col = Significant)) + 
  geom_hline(yintercept = 0, lty = 3) + 
  geom_pointrange() + 
  scale_color_manual(values = c('FALSE' = 'black', 'TRUE' = '#e34a33')) + 
  ylab(expression(log(sigma[ij]^2)~'for stage transition parameters')) +  
  xlab('Stage') + 
  facet_wrap(~covariate) + 
  theme_few() + 
  coord_flip() + 
  ggtitle('Posterior means and HPD intervals for random effect variance')

```

```{r speed_raneff_var, fig.cap='\\label{fig:beta_var}Posterior means and HPDs for population-level variance of random effects for vertical speed parameters.'}
library(coda)
library(ggplot2)
library(ggthemes)

param_grid = expand.grid(
  covariate = 1:nim_pkg$consts$n_covariates,
  stage = 1:nim_pkg$consts$n_stages
)

param_results = do.call(rbind, apply(param_grid, 1, function(r) { 
  
  tgt_mu = paste('beta_var[', r['covariate'], ', ', r['stage'], ']', 
                 sep = '')
  
  m = mcmc(log(param_samples[-burn, tgt_mu]))
  
  if(var(m) == 0) {
    NULL 
  } else {
    hpds = HPDinterval(m)
    data.frame(t(r), mean = mean(m), hpds, ess = effectiveSize(m),
               Significant = ifelse(hpds[1, 'lower'] > 0 | hpds[1, 'upper'] < 0, 
                               TRUE, FALSE))
  }
}))

param_results$stage = factor(
  x = param_results$stage, 
  levels = 1:nim_pkg$consts$n_stages,
  labels = names(nim_pkg$consts$movement_types)
)

param_results$covariate = factor(
  x = param_results$covariate, 
  levels = 1:nim_pkg$consts$n_covariates,
  labels = rownames(nim_pkg$data$covariates)
)

ggplot(param_results, aes(x = stage, y = mean, ymin = lower, 
                         ymax = upper, col = Significant)) + 
  geom_hline(yintercept = 0, lty = 3) + 
  geom_pointrange() + 
  scale_color_manual(values = c('FALSE' = 'black', 'TRUE' = '#e34a33')) + 
  ylab(expression(log(sigma[ij]^2)~'for vertical speed parameters')) +  
  xlab('Stage') + 
  facet_wrap(~covariate) + 
  theme_few() + 
  coord_flip() + 
  ggtitle('Posterior means and HPD intervals for random effect variance')

```